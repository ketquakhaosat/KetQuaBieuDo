<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi·ªÉu ƒê·ªì K·∫øt Qu·∫£</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
            padding: 24px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: clamp(1.6rem, 3vw, 2.3rem);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .chart-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e5e5;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            line-height: 1.4;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .loading {
            text-align: center;
            padding: 32px;
            color: #666;
            font-size: 1rem;
        }

        .error {
            text-align: center;
            padding: 16px;
            background: #fee;
            color: #c33;
            border-radius: 10px;
            margin: 16px 0;
            font-size: 0.95rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 16px;
            }
            .chart-wrapper {
                height: 260px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Bi·ªÉu ƒê·ªì K·∫øt Qu·∫£</h1>
        
        <div id="loading" class="loading">
            ƒêang t·∫£i d·ªØ li·ªáu t·ª´ data.xlsx...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="chartsContainer" class="charts-container"></div>
    </div>

    <script>
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const chartsContainer = document.getElementById('chartsContainer');
        const charts = [];

        const colorPalette = [
            '#667eea', '#764ba2', '#ed6490', '#ff9a9e', '#f8c102',
            '#4bc0c0', '#36a2eb', '#ff6384', '#8bc34a', '#ffb74d',
            '#26c6da', '#ab47bc', '#5c6bc0', '#9ccc65', '#ffa726'
        ];

        // C√°c c·∫•u h√¨nh ƒë·∫∑c bi·ªát cho t·ª´ng c√¢u h·ªèi
        const specialConfigs = [
            {
                match: ['th·ªùi gian'],
                skip: true
            },
            {
                // 1. ƒê·ªëi t∆∞·ª£ng kh·∫£o s√°t: bi·ªÉu ƒë·ªì c·ªôt
                match: ['ƒë·ªëi t∆∞·ª£ng kh·∫£o s√°t'],
                type: 'bar',
                labelMap: {
                    'h·ªçc sinh': 'H·ªçc sinh',
                    'hs': 'H·ªçc sinh',
                    'ph·ª• huynh': 'Ph·ª• huynh',
                    'gi√°o vi√™n': 'Gi√°o vi√™n',
                    'gv': 'Gi√°o vi√™n',
                    'sinh vi√™n': 'Sinh vi√™n',
                    'sv': 'Sinh vi√™n',
                    'ng∆∞·ªùi ƒëi l√†m': 'Ng∆∞·ªùi ƒëi l√†m',
                    'ƒëi l√†m': 'Ng∆∞·ªùi ƒëi l√†m'
                }
            },
            {
                // 2. ƒê·ªô tu·ªïi: bi·ªÉu ƒë·ªì c·ªôt
                match: ['ƒë·ªô tu·ªïi'],
                type: 'bar'
            },
            {
                // 3. M√†u s·∫Øc s·∫£n ph·∫©m: bi·ªÉu ƒë·ªì tr√≤n (nh√≥m theo s·ªë 1,2,3,4,5)
                match: ['m√†u s·∫Øc'],
                type: 'pie',
                groupByNumber: true,
                labelMap: {
                    '1': 'Nh√≥m 1',
                    '2': 'Nh√≥m 2',
                    '3': 'Nh√≥m 3',
                    '4': 'Nh√≥m 4',
                    '5': 'Nh√≥m 5'
                }
            },
            {
                // 4. M√πi h∆∞∆°ng s·∫£n ph·∫©m: bi·ªÉu ƒë·ªì tr√≤n (nh√≥m theo s·ªë 1,2,3,4,5)
                match: ['m√πi h∆∞∆°ng'],
                type: 'pie',
                groupByNumber: true,
                labelMap: {
                    '1': 'Nh√≥m 1',
                    '2': 'Nh√≥m 2',
                    '3': 'Nh√≥m 3',
                    '4': 'Nh√≥m 4',
                    '5': 'Nh√≥m 5'
                }
            },
            {
                // 5. C·∫£m gi√°c tr√™n da tay khi s·ª≠ d·ª•ng: bi·ªÉu ƒë·ªì tr√≤n (nh√≥m theo s·ªë 1,2,3,4,5)
                match: ['c·∫£m gi√°c tr√™n da s·ª≠ d·ª•ng', 'c·∫£m gi√°c tr√™n da', 'c·∫£m gi√°c tr√™n da tay khi s·ª≠ d·ª•ng'],
                type: 'pie',
                groupByNumber: true,
                labelMap: {
                    '1': 'Nh√≥m 1',
                    '2': 'Nh√≥m 2',
                    '3': 'Nh√≥m 3',
                    '4': 'Nh√≥m 4',
                    '5': 'Nh√≥m 5'
                }
            },
            {
                // 6. C·∫£m gi√°c s·∫°ch sau khi s·ª≠ d·ª•ng: bi·ªÉu ƒë·ªì tr√≤n (nh√≥m theo s·ªë 1,2,3,4,5)
                match: ['c·∫£m gi√°c sau khi s·ª≠ d·ª•ng', 'sau khi s·ª≠ d·ª•ng', 'c·∫£m gi√°c s·∫°ch sau khi s·ª≠ d·ª•ng'],
                type: 'pie',
                groupByNumber: true,
                labelMap: {
                    '1': 'Nh√≥m 1',
                    '2': 'Nh√≥m 2',
                    '3': 'Nh√≥m 3',
                    '4': 'Nh√≥m 4',
                    '5': 'Nh√≥m 5'
                }
            },
            {
                // 7. M·ª©c ƒë·ªô ti·ªán l·ª£i khi s·ª≠ d·ª•ng: bi·ªÉu ƒë·ªì tr√≤n (nh√≥m theo s·ªë 1,2,3,4,5)
                match: ['m·ª©c ƒë·ªô ti·ªán l·ª£i'],
                type: 'pie',
                groupByNumber: true,
                labelMap: {
                    '1': 'Nh√≥m 1',
                    '2': 'Nh√≥m 2',
                    '3': 'Nh√≥m 3',
                    '4': 'Nh√≥m 4',
                    '5': 'Nh√≥m 5'
                }
            },
            {
                // 8. Anh/ch·ªã c√≥ s·∫µn s√†ng s·ª≠ d·ª•ng s·∫£n ph·∫©m r·ª≠a tay s√°t khu·∫©n t·ª´ th·∫£o d∆∞·ª£c kh√¥ng?: bi·ªÉu ƒë·ªì c·ªôt
                match: ['s·∫µn s√†ng s·ª≠ d·ª•ng s·∫£n ph·∫©m r·ª≠a tay s√°t khu·∫©n t·ª´ th·∫£o d∆∞·ª£c'],
                type: 'bar',
                labelMap: {
                    'c√≥': 'C√≥',
                    'kh√¥ng': 'Kh√¥ng',
                    'ko': 'Kh√¥ng'
                }
            },
            {
                // 9. Theo anh/ch·ªã, s·∫£n ph·∫©m ph√π h·ª£p s·ª≠ d·ª•ng ·ªü ƒë√¢u?: bi·ªÉu ƒë·ªì c·ªôt
                match: ['ph√π h·ª£p s·ª≠ d·ª•ng ·ªü ƒë√¢u', 's·∫£n ph·∫©m ph√π h·ª£p s·ª≠ d·ª•ng ·ªü ƒë√¢u'],
                type: 'bar'
            },
            {
                // 10. ƒê√°nh gi√° kh·∫£ nƒÉng ·ª©ng d·ª•ng th·ª±c ti·ªÖn c·ªßa s·∫£n ph·∫©m: bi·ªÉu ƒë·ªì c·ªôt
                match: ['ƒë√°nh gi√° kh·∫£ nƒÉng ·ª©ng d·ª•ng th·ª±c ti·ªÖn', 'kh·∫£ nƒÉng ·ª©ng d·ª•ng th·ª±c ti·ªÖn'],
                type: 'bar'
            },
            {
                // 11. Theo √¥ng/b√† (anh/ch·ªã), m·ª©c gi√° n√†o l√† ph√π h·ª£p cho s·∫£n ph·∫©m s√°t khu·∫©n t·ª´ d·ªãch chi·∫øt Ri·ªÅng Mai gan (chai 150ml)?: bi·ªÉu ƒë·ªì c·ªôt
                match: ['m·ª©c gi√° n√†o l√† ph√π h·ª£p', 'm·ª©c gi√°', 'gi√° ph√π h·ª£p', 'ri·ªÅng mai gan'],
                type: 'bar'
            },
            {
                // 12. Theo anh/ch·ªã, s·∫£n ph·∫©m c·∫ßn c·∫£i thi·ªán ƒëi·ªÉm n√†o?: bi·ªÉu ƒë·ªì c·ªôt
                match: ['s·∫£n ph·∫©m c·∫ßn c·∫£i thi·ªán ƒëi·ªÉm n√†o', 'c·∫ßn c·∫£i thi·ªán ƒëi·ªÉm n√†o', 'c·∫£i thi·ªán'],
                type: 'bar'
            }
        ];

        function getConfig(header) {
            const lower = header.toLowerCase();
            return specialConfigs.find(cfg => cfg.match.some(key => lower.includes(key)));
        }

        function mapLabel(label, labelMap) {
            if (!labelMap) return label;
            const lower = String(label).toLowerCase().trim();
            return labelMap[lower] || label;
        }

        function getColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(colorPalette[i % colorPalette.length]);
            }
            return colors;
        }

        // Function ƒë·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ ArrayBuffer
        function processExcelData(arrayBuffer, fileDisplayName = 'data.xlsx') {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // L·∫•y sheet ƒë·∫ßu ti√™n
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Chuy·ªÉn ƒë·ªïi sang JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length === 0) {
                    showError('File Excel kh√¥ng c√≥ d·ªØ li·ªáu!');
                    return;
                }

                // L·∫•y header (d√≤ng ƒë·∫ßu ti√™n)
                const headers = jsonData[0];
                if (!headers || headers.length === 0) {
                    showError('File Excel kh√¥ng c√≥ c·ªôt ti√™u ƒë·ªÅ!');
                    return;
                }

                // X√≥a bi·ªÉu ƒë·ªì c≈©
                chartsContainer.innerHTML = '';
                charts.forEach(chart => chart.destroy());
                charts.length = 0;

                // X·ª≠ l√Ω t·ª´ng c·ªôt
                headers.forEach((header, colIndex) => {
                    if (!header || header === '') return;

                    const config = getConfig(header);
                    if (config && config.skip) return;
                    
                    // L·∫•y d·ªØ li·ªáu c·ªßa c·ªôt (b·ªè qua d√≤ng ƒë·∫ßu ti√™n l√† header)
                    const columnData = jsonData.slice(1)
                        .map(row => row[colIndex])
                        .filter(val => val !== undefined && val !== null && val !== '');
                    
                    if (columnData.length === 0) return;

                    // N·∫øu c√≥ config ƒë·∫∑c bi·ªát (pie ho·∫∑c bar), lu√¥n x·ª≠ l√Ω nh∆∞ category chart
                    // Kh√¥ng quan t√¢m ƒë·∫øn vi·ªác d·ªØ li·ªáu c√≥ ph·∫£i l√† s·ªë hay kh√¥ng
                    if (config) {
                        createSpecialOrCategoryChart(header, columnData, config);
                        return;
                    }

                    // Ki·ªÉm tra xem d·ªØ li·ªáu l√† s·ªë hay text (ch·ªâ cho c√°c c·ªôt kh√¥ng c√≥ config)
                    const isNumeric = columnData.every(val => !isNaN(parseFloat(val)) && isFinite(val));
                    
                    if (isNumeric) {
                        createNumericChart(header, columnData);
                    } else {
                        createSpecialOrCategoryChart(header, columnData, config);
                    }
                });

                loading.style.display = 'none';
                
            } catch (err) {
                showError('L·ªói khi ƒë·ªçc file: ' + err.message);
            }
        }

        // Function ƒë·ªÉ load file t·ª´ URL
        async function loadExcelFromUrl(url, displayName) {
            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                processExcelData(arrayBuffer, displayName);
            } catch (err) {
                loading.style.display = 'none';
                showError('L·ªói khi t·∫£i file data.xlsx: ' + err.message + '. Vui l√≤ng ki·ªÉm tra l·∫°i file data.xlsx c√≥ t·ªìn t·∫°i trong repository kh√¥ng.');
                console.error('Chi ti·∫øt l·ªói:', err);
            }
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            loading.style.display = 'none';
        }

        function createNumericChart(columnName, data) {
            const numericData = data.map(val => parseFloat(val));
            const labels = Array.from({ length: numericData.length }, (_, i) => `M·∫´u ${i + 1}`);
            
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-title">${columnName}</div>
                <div class="chart-wrapper">
                    <canvas id="chart-${charts.length}"></canvas>
                </div>
            `;
            
            chartsContainer.appendChild(chartCard);
            
            const ctx = document.getElementById(`chart-${charts.length}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: columnName,
                        data: numericData,
                        borderColor: getRandomColor(),
                        backgroundColor: getRandomColor(0.1),
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            charts.push(chart);
        }

        function createCategoryChart(columnName, data) {
            // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa m·ªói gi√° tr·ªã
            const counts = {};
            data.forEach(val => {
                const key = String(val);
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const labels = Object.keys(counts);
            const values = Object.values(counts);
            const colors = getColors(labels.length);
            
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-title">${columnName}</div>
                <div class="chart-wrapper">
                    <canvas id="chart-${charts.length}"></canvas>
                </div>
            `;
            
            chartsContainer.appendChild(chartCard);
            
            const ctx = document.getElementById(`chart-${charts.length}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng',
                        data: values,
                        backgroundColor: colors.map(c => `${c}B3`),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            charts.push(chart);
        }

        function createPieChart(columnName, labels, values) {
            const colors = getColors(labels.length);
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-title">${columnName}</div>
                <div class="chart-wrapper">
                    <canvas id="chart-${charts.length}"></canvas>
                </div>
            `;

            chartsContainer.appendChild(chartCard);

            const ctx = document.getElementById(`chart-${charts.length}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.formattedValue || '';
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            charts.push(chart);
        }

        function createBarChart(columnName, labels, values) {
            const colors = getColors(labels.length);
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-title">${columnName}</div>
                <div class="chart-wrapper">
                    <canvas id="chart-${charts.length}"></canvas>
                </div>
            `;

            chartsContainer.appendChild(chartCard);

            const ctx = document.getElementById(`chart-${charts.length}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng',
                        data: values,
                        backgroundColor: colors.map(c => `${c}B3`),
                        borderColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.formattedValue || '';
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            charts.push(chart);
        }

        function createSpecialOrCategoryChart(columnName, data, config) {
            const counts = {};
            
            // X·ª≠ l√Ω d·ªØ li·ªáu: nh√≥m theo s·ªë n·∫øu c√≥ flag groupByNumber
            data.forEach(val => {
                let key;
                
                if (config?.groupByNumber) {
                    // N·∫øu c√≥ groupByNumber, chuy·ªÉn gi√° tr·ªã th√†nh s·ªë r·ªìi nh√≥m l·∫°i
                    // V√≠ d·ª•: 1, 2, 3, 4, 5 s·∫Ω ƒë∆∞·ª£c nh√≥m th√†nh "1", "2", "3", "4", "5"
                    const numVal = parseFloat(val);
                    if (isNaN(numVal) || !isFinite(numVal)) return;
                    key = String(numVal); // Gi·ªØ nguy√™n s·ªë ƒë·ªÉ nh√≥m
                } else {
                    // X·ª≠ l√Ω nh∆∞ text: chuy·ªÉn th√†nh string v√† gi·ªØ nguy√™n gi√° tr·ªã g·ªëc
                    const strVal = String(val).trim();
                    if (strVal === '' || strVal === 'undefined' || strVal === 'null') return;
                    key = strVal;
                }
                
                // √Åp d·ª•ng labelMap n·∫øu c√≥ ƒë·ªÉ ƒë·ªïi t√™n nh√≥m (v√≠ d·ª•: "1" -> "Nh√≥m 1")
                const mapped = mapLabel(key, config?.labelMap);
                counts[mapped] = (counts[mapped] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const values = Object.values(counts);

            if (config?.type === 'pie') {
                createPieChart(columnName, labels, values);
                return;
            }

            // N·∫øu c√≥ config v√† type l√† bar, ho·∫∑c kh√¥ng c√≥ config (m·∫∑c ƒë·ªãnh l√† bar)
            if (config?.type === 'bar' || !config) {
                createBarChart(columnName, labels, values);
                return;
            }

            // Fallback
            createBarChart(columnName, labels, values);
        }

        function getRandomColor(alpha = 1) {
            const colors = [
                `rgba(102, 126, 234, ${alpha})`,
                `rgba(118, 75, 162, ${alpha})`,
                `rgba(237, 100, 166, ${alpha})`,
                `rgba(255, 154, 158, ${alpha})`,
                `rgba(250, 208, 196, ${alpha})`,
                `rgba(113, 206, 255, ${alpha})`,
                `rgba(68, 184, 172, ${alpha})`,
                `rgba(255, 193, 7, ${alpha})`,
                `rgba(233, 30, 99, ${alpha})`,
                `rgba(156, 39, 176, ${alpha})`
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // T·ª± ƒë·ªông load file data.xlsx t·ª´ GitHub Pages ngay khi trang web ƒë∆∞·ª£c m·ªü
        window.addEventListener('DOMContentLoaded', async function() {
            // Hi·ªÉn th·ªã loading ngay l·∫≠p t·ª©c
            loading.style.display = 'block';
            
            // T·∫£i file data.xlsx t·ª´ c√πng th∆∞ m·ª•c tr√™n GitHub Pages
            // File n√†y ƒë√£ ƒë∆∞·ª£c upload l√™n GitHub repository
            loadExcelFromUrl('data.xlsx', 'data.xlsx');
        });
    </script>
</body>
</html>
